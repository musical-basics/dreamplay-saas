datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

model Customer {
  id                String                 @id @default(uuid())
  email             String                 @unique
  name              String?
  shopifyCustomerId String?
  createdAt         DateTime               @default(now())
  journeyStates     CustomerJourneyState[]
  analyticsEvents   AnalyticsEvent[]
}

model ContentTemplate {
  id       String        @id @default(uuid())
  slug     String        @unique // Templates have unique slugs globally
  name     String
  type     ContentType
  body     String
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  previewData Json?
  
  // Many-to-many relation with Configuration via junction table
  configurations ConfigurationTemplate[]
  
  steps    JourneyStep[]
  campaigns Campaign[]
  analyticsEvents AnalyticsEvent[]
}

model Configuration {
  id        String   @id @default(uuid())
  name      String   // e.g., "Default Site", "Summer Sale"
  slug      String   @unique // URL prefix: "main", "summer-25"
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  
  // Many-to-many relation with ContentTemplate via junction table
  templates ConfigurationTemplate[]
  navLinks  NavLink[]
}

// Junction table for many-to-many template-configuration relationship
model ConfigurationTemplate {
  id              String        @id @default(uuid())
  configurationId String
  configuration   Configuration @relation(fields: [configurationId], references: [id], onDelete: Cascade)
  templateId      String
  template        ContentTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  createdAt       DateTime      @default(now())
  
  @@unique([configurationId, templateId])
}

model NavLink {
  id              String        @id @default(uuid())
  label           String
  url             String
  order           Int
  configurationId String
  configuration   Configuration @relation(fields: [configurationId], references: [id], onDelete: Cascade)
}

enum ContentType {
  EMAIL
  LANDING
  CHECKOUT
}


model Journey {
  id        String        @id @default(uuid())
  name      String
  slug      String        @unique
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  status    JourneyStatus @default(DRAFT)
  steps     JourneyStep[]
  campaigns Campaign[]
  analyticsEvents AnalyticsEvent[]
}

enum JourneyStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
}

model JourneyStep {
  id         String          @id @default(uuid())
  order      Int
  journeyId  String
  journey    Journey         @relation(fields: [journeyId], references: [id], onDelete: Cascade)
  templateId String
  template   ContentTemplate @relation(fields: [templateId], references: [id])

  @@unique([journeyId, order])
}

model CustomerJourneyState {
  id           String   @id @default(uuid())
  customerId   String
  customer     Customer @relation(fields: [customerId], references: [id])
  currentStepId String?
  status       String
  lastUpdated  DateTime @default(now())
}

model Campaign {
  id         String          @id @default(uuid())
  name       String
  status     CampaignStatus  @default(DRAFT)
  audience   String          @default("ALL") // "ALL" or "TEST_GROUP"
  
  templateId String
  template   ContentTemplate @relation(fields: [templateId], references: [id])
  
  journeyId  String
  journey    Journey         @relation(fields: [journeyId], references: [id])
  
  sentCount  Int             @default(0)
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  analyticsEvents AnalyticsEvent[]
}

enum CampaignStatus {
  DRAFT
  SENT
}

model AnalyticsEvent {
  id        String   @id @default(uuid())
  type      String   // "VIEW", "CLICK"
  url       String
  meta      Json?
  
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])
  
  journeyId  String?
  journey    Journey?  @relation(fields: [journeyId], references: [id])
  
  templateId String?
  template   ContentTemplate? @relation(fields: [templateId], references: [id])
  
  campaignId String?
  campaign   Campaign? @relation(fields: [campaignId], references: [id])
  
  createdAt DateTime @default(now())
}

model Asset {
  id        String   @id @default(uuid())
  name      String
  url       String   @unique
  mimeType  String?
  size      Int?     // Size in bytes
  createdAt DateTime @default(now())
}

